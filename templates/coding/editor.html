{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Monaco Editor</title>

<!-- Monaco & Material Icons -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.34.0/min/vs/loader.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mdi/font@6.5.95/css/materialdesignicons.min.css">

<style>
/* ── transparent scrollbar everywhere ───────────────────────────── */
*::-webkit-scrollbar{width:10px!important;height:10px!important;background:transparent!important}
*::-webkit-scrollbar-track,*::-webkit-scrollbar-corner{background:transparent!important}
*::-webkit-scrollbar-thumb{background:#424242!important;border:2px solid transparent!important;border-radius:5px!important}
*::-webkit-scrollbar-thumb:hover{background:#525252!important}
#file-explorer,#terminal,.monaco-scrollable-element{scrollbar-width:thin;scrollbar-color:#424242 transparent;-ms-overflow-style:none;transition:scrollbar-color .2s}
#file-explorer:not(:hover)::-webkit-scrollbar-thumb,
#terminal:not(:hover)::-webkit-scrollbar-thumb,
.monaco-scrollable-element:not(:hover)::-webkit-scrollbar-thumb{background:transparent}

/* ── layout ─────────────────────────────────────────────────────── */
body{margin:0;padding:0;overflow:hidden;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Open Sans','Helvetica Neue',sans-serif;background:#1e1e1e}
#container{display:flex;height:100vh;background:#1e1e1e}

/* Explorer pane */
#file-explorer{min-width:100px;max-width:600px;width:250px;background:#252526;color:#fff;overflow-y:auto;font-size:13px;flex-shrink:0}
.explorer-title{padding:10px 20px;font-size:11px;text-transform:uppercase;font-weight:700;letter-spacing:1px;color:#bbb;background:#252526}

/* Terminal title */
.terminal-title{padding:6px 10px;font-size:11px;text-transform:uppercase;font-weight:700;letter-spacing:1px;color:#bbb;background:#1e1e1e;border-top:1px solid #333;border-bottom:1px solid #333;display:flex;align-items:center;justify-content:space-between}

/* Editor / terminal column */
#editor-container{flex-grow:1;display:flex;flex-direction:column;background:#1e1e1e}
#monaco-editor{flex-grow:1}
#h-resizer{height:5px;width:100%;background:#1e1e1e;cursor:row-resize;transition:background .2s}
#h-resizer:hover,#h-resizer.dragging{background:#0e639c}

/* Terminal WebSocket Styles */

/* Terminal container enhancements */
#terminal {
    height: 300px;
    background: #1e1e1e;
    overflow: hidden;
    border-top: 1px solid #333;
    box-shadow: inset 0 0 8px rgba(0,0,0,.6);
    padding: 0;
    display: flex;
    flex-direction: column;
}

/* Terminal title with status */
.terminal-title {
    padding: 6px 10px;
    font-size: 11px;
    text-transform: uppercase;
    font-weight: 700;
    letter-spacing: 1px;
    color: #bbb;
    background: #1e1e1e;
    border-top: 1px solid #333;
    border-bottom: 1px solid #333;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

/* Terminal status indicator */
#terminal-status {
    font-size: 10px;
    color: #777;
    margin-left: 10px;
    font-weight: normal;
}

/* Terminal buttons */
.terminal-button {
    background: #0e639c;
    color: white;
    border: none;
    padding: 4px 10px;
    border-radius: 3px;
    cursor: pointer;
    font-size: 11px;
    margin-left: 5px;
    transition: background-color 0.2s;
}

.terminal-button:hover {
    background: #1177BB;
}

.terminal-button.prominent {
    background: #2ea043;
    font-weight: bold;
    display: flex;
    align-items: center;
    padding: 5px 10px;
}

.terminal-button.prominent:hover {
    background: #3bbd55;
}

.terminal-button.prominent i {
    margin-right: 5px;
}

/* Terminal iframe */
#terminal-iframe {
    flex-grow: 1;
    width: 100%;
    border: none;
    background: #1e1e1e;
}

/* Connection status colors */
.status-connected { color: #0dbc79 !important; }
.status-disconnected { color: #f14c4c !important; }
.status-connecting { color: #fcce0c !important; }

/* File‑tree */
.file-tree{list-style:none;padding:0;margin:0;background:#252526}
.file-item{display:flex;align-items:center;padding:4px 8px 4px 20px;cursor:pointer;user-select:none;white-space:nowrap;background:transparent}
.file-item:hover{background:#2a2d2e}
.file-item.active{background:#37373d}
.file-item i{margin-right:6px;font-size:16px;width:16px;text-align:center;color:#c5c5c5}
.directory>.file-item{padding-left:calc(20px*var(--depth,1))}
.file-item.file{padding-left:calc(20px*var(--depth,1))}
.directory>.file-item i.mdi-chevron-right{transition:transform .15s}
.directory.expanded>.file-item i.mdi-chevron-right{transform:rotate(90deg)}
.directory>.file-tree{display:none}
.directory.expanded>.file-tree{display:block}

/* Monaco background override */
.monaco-editor,.monaco-editor .margin,.monaco-editor-background,
.monaco-editor .inputarea.ime-input{background:#1e1e1e!important}

/* Vertical resizer */
#resizer{width:5px;background:#1e1e1e;cursor:col-resize;transition:background .2s}
#resizer:hover,#resizer.dragging{background:#0e639c}
.dragging{user-select:none}

/* Context‑menu */
.context-menu{position:fixed;background:#252526;border:1px solid #454545;box-shadow:0 2px 8px rgba(0,0,0,.15);padding:4px 0;min-width:150px;z-index:1000}
.context-menu-item{padding:6px 12px;cursor:pointer;color:#ccc;font-size:13px;display:flex;align-items:center}
.context-menu-item:hover{background:#094771;color:#fff}
.context-menu-item i{margin-right:8px;font-size:16px}
.context-menu-separator{height:1px;background:#454545;margin:4px 0}
.context-menu-item.danger{color:#f14c4c}
.context-menu-item.danger:hover{background:#3c1f1f;color:#ff6b6b}

/* No context message */
.no-context-message {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    max-width: 600px;
    padding: 30px;
    background: #252526;
    border: 1px solid #454545;
    color: #d4d4d4;
    border-radius: 5px;
    box-shadow: 0 4px 16px rgba(0,0,0,.3);
    text-align: center;
}
.no-context-message h2 {
    margin-top: 0;
    color: #0e639c;
}
.no-context-message p {
    margin-bottom: 20px;
}
.no-context-message code {
    display: block;
    background: #1e1e1e;
    padding: 10px;
    border-radius: 4px;
    margin: 15px 0;
    font-family: Consolas, monospace;
}
</style>
</head>
<body>
{% if no_context %}
<div class="no-context-message">
    <h2>Missing Context</h2>
    <p>{{ message }}</p>
    <p>Examples:</p>
    <code>/coding/editor/?project_id=my-project-123</code>
    <p>or</p>
    <code>/coding/editor/?conversation_id=my-conversation-456</code>
</div>
{% else %}
<div id="container">
    <!-- Explorer -->
    <div id="file-explorer">
        <div class="explorer-title">EXPLORER</div>
        <div id="file-tree-container"></div>
    </div>

    <!-- Vertical resizer -->
    <div id="resizer"></div>

    <!-- Editor + horizontal resizer + terminal -->
    <div id="editor-container">
        <div id="monaco-editor"></div>
        <div id="h-resizer"></div>
        
        <!-- Terminal Container -->
        <div id="terminal" class="terminal-container" {% if project_id %}data-project-id="{{ project_id }}"{% endif %} {% if conversation_id %}data-conversation-id="{{ conversation_id }}"{% endif %}>
            <div class="terminal-header">
                <div class="terminal-title">
                    TERMINAL <span id="terminal-status" style="margin-left: 5px; color: #fcce0c;">(Initializing...)</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; background-color: #2d2d2d; border-bottom: 1px solid #333;">
                    <div style="display: flex; align-items: center; color: #f3ca3c;">
                        <i class="mdi mdi-key" style="margin-right: 5px;"></i>
                        <span style="font-size: 12px;">Login with: <code style="background: #1e1e1e; padding: 2px 4px; border-radius: 3px;">user</code> / <code style="background: #1e1e1e; padding: 2px 4px; border-radius: 3px;">password</code></span>
                    </div>
                    <button id="open-external-terminal" class="terminal-button prominent"><i class="mdi mdi-open-in-new"></i>Open Terminal in New Window</button>
                </div>
            </div>
            <iframe id="terminal-iframe" src="about:blank"></iframe>
        </div>
    </div>
</div>

<!-- Context‑menu -->
<div id="context-menu" class="context-menu" style="display:none">
    <div class="context-menu-item" onclick="createNewFile()"><i class="mdi mdi-file-plus"></i>New File</div>
    <div class="context-menu-item" onclick="createNewFolder()"><i class="mdi mdi-folder-plus"></i>New Folder</div>
    <div class="context-menu-separator"></div>
    <div class="context-menu-item" onclick="renameItem()"><i class="mdi mdi-pencil"></i>Rename</div>
    <div class="context-menu-item danger" onclick="deleteItem()"><i class="mdi mdi-delete"></i>Delete</div>
</div>

<script>
/*─────────────────────────────────────────────────────────────
  Get project_id and conversation_id from URL parameters
─────────────────────────────────────────────────────────────*/
const urlParams = new URLSearchParams(window.location.search);
const projectId = urlParams.get('project_id');
const conversationId = urlParams.get('conversation_id');

/*─────────────────────────────────────────────────────────────
  Context‑menu helpers
─────────────────────────────────────────────────────────────*/
let contextMenuTarget=null;
function showContextMenu(e,target){
    e.preventDefault();
    const m=document.getElementById('context-menu');
    m.style.display='block';m.style.left=e.pageX+'px';m.style.top=e.pageY+'px';
    contextMenuTarget=target;
}
function hideContextMenu(){document.getElementById('context-menu').style.display='none';contextMenuTarget=null}
document.addEventListener('contextmenu',e=>{
    const item=e.target.closest('#file-explorer .file-item');
    if(item)showContextMenu(e,item);
});
document.addEventListener('click',hideContextMenu);

/*─────────────────────────────────────────────────────────────
  Icon map
─────────────────────────────────────────────────────────────*/
const fileIcons={py:'language-python',js:'language-javascript',jsx:'language-javascript',ts:'language-typescript',tsx:'language-typescript',html:'language-html5',css:'language-css3',scss:'language-sass',less:'language-less',php:'language-php',java:'language-java',cpp:'language-cpp',c:'language-c',cs:'language-csharp',go:'language-go',rb:'language-ruby',rs:'language-rust',swift:'language-swift',kt:'language-kotlin',json:'code-json',xml:'code-tags',svg:'svg',vue:'vuejs',react:'react',yml:'code-braces',yaml:'code-braces',toml:'code-braces',ini:'code-braces',conf:'cog',config:'cog',dockerfile:'docker','docker-compose.yml':'docker','docker-compose.yaml':'docker',sh:'console',bash:'console',zsh:'console',fish:'console',md:'language-markdown',txt:'text',pdf:'file-pdf-box',doc:'file-word-box',docx:'file-word-box',xls:'file-excel-box',xlsx:'file-excel-box',ppt:'file-powerpoint-box',pptx:'file-powerpoint-box',sql:'database',sqlite:'database',sqlite3:'database',db:'database',png:'file-image',jpg:'file-image',jpeg:'file-image',gif:'file-image',ico:'file-image',webp:'file-image',zip:'zip-box',rar:'zip-box','7z':'zip-box',tar:'zip-box',gz:'zip-box','.gitignore':'git','.gitmodules':'git','.gitattributes':'git','package.json':'nodejs','package-lock.json':'nodejs','requirements.txt':'language-python',Pipfile:'language-python','poetry.lock':'language-python','composer.json':'language-php',Gemfile:'language-ruby','pom.xml':'language-java','build.gradle':'language-java',default:'file-document-outline'};
function getFileIcon(name){if(fileIcons[name.toLowerCase()])return fileIcons[name.toLowerCase()];const ext=name.split('.').pop().toLowerCase();return fileIcons[ext]||fileIcons.default}

/*─────────────────────────────────────────────────────────────
  Monaco boot‑strap
─────────────────────────────────────────────────────────────*/
require.config({paths:{vs:'https://cdn.jsdelivr.net/npm/monaco-editor@0.34.0/min/vs'}});
require(['vs/editor/editor.main'],()=>{

const editor=monaco.editor.create(document.getElementById('monaco-editor'),{value:'',language:'javascript',theme:'vs-dark',automaticLayout:true});
// expose for other handlers
window.editor = editor;

let currentFile='';let activeItem=null;

/*── render tree ──────────────────────────────────────────*/
function renderFileTree(items,isRoot=false,depth=1){
    let html='<ul class="file-tree"'+(isRoot?' id="root-tree"':'')+'>';
    html+=items.map(item=>{
        if(item.type==='directory'){
            return`<li class="directory" style="--depth:${depth}">
                      <div class="file-item" data-path="${item.path}">
                          <i class="mdi mdi-chevron-right"></i>
                          <i class="mdi mdi-folder${item.name.startsWith('.')?'-hidden':''}"></i>${item.name}
                      </div>
                      ${renderFileTree(item.children,false,depth+1)}
                    </li>`;
        }
        return`<li style="--depth:${depth}">
                  <div class="file-item file" data-path="${item.path}">
                      <i class="mdi mdi-${getFileIcon(item.name)}"></i>${item.name}
                  </div>
                </li>`;
    }).join('');
    return html+'</ul>';
}

/*── load / refresh tree ─────────────────────────────────*/
function loadFileTree(){
    const container=document.getElementById('file-tree-container');
    const expanded=Array.from(container.querySelectorAll('.directory.expanded>.file-item'))
                        .map(it=>it.dataset.path);
    const scrollPos=container.scrollTop;

    // Create request data with optional project_id or conversation_id
    const requestData = {};
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    return fetch('/coding/get_file_tree/', {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'Cache-Control': 'no-cache'},
        body: JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(data=>{
        if (data.error) {
            appendToTerminal('Error loading file tree: ' + data.error, 'error');
            return;
        }
            
        const newHTML=renderFileTree(data.files,true);
        if(container.innerHTML===newHTML)return;

        container.innerHTML=newHTML;
        expanded.forEach(path=>{
            const el=container.querySelector(`.directory>.file-item[data-path="${path}"]`);
            if(el)el.parentElement.classList.add('expanded');
        });
        container.querySelectorAll('.directory>.file-item').forEach(item=>{
            item.addEventListener('click',e=>{
                e.stopPropagation();
                item.parentElement.classList.toggle('expanded');
            });
        });
        container.querySelectorAll('.file-item.file').forEach(item=>{
            const p=item.dataset.path;
            item.onclick=()=>openFile(p,item);
        });
        if(currentFile){
            const again=container.querySelector(`.file-item[data-path="${currentFile}"]`);
            if(again){again.classList.add('active');activeItem=again;}
        }
        container.scrollTop=scrollPos;
    })
    .catch(err=>appendToTerminal('Error loading file tree: '+err,'error'));
}
const refreshTree=loadFileTree;

/*── open file ───────────────────────────────────────────*/
function openFile(path,element){
    if(activeItem)activeItem.classList.remove('active');
    element.classList.add('active');
    activeItem=element;
    currentFile=path;

    // Create request data with path and optional project_id or conversation_id
    const requestData = { path };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/get_file_content/',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(data=>{
        if (data.error) {
            appendToTerminal('Error opening file: ' + data.error, 'error');
            return;
        }
        const ext=path.split('.').pop();
        const lang=monaco.languages.getLanguages().find(l=>l.extensions?.includes('.'+ext))?.id||'plaintext';
        editor.setModel(monaco.editor.createModel(data.content,lang));
    })
    .catch(err => appendToTerminal('Error opening file: ' + err, 'error'));
}

/*── auto‑save ───────────────────────────────────────────*/
let saveTimeout;
editor.onDidChangeModelContent(()=>{
    if(!currentFile)return;
    clearTimeout(saveTimeout);
    saveTimeout=setTimeout(saveFile,1000);
});
function saveFile(){
    if(!currentFile)return;

    // Create request data with path, content, and optional project_id or conversation_id
    const requestData = { 
        path: currentFile,
        content: editor.getValue()
    };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/save_file/',{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(data=>{
        if (data.error) {
            appendToTerminal('Error saving file: ' + data.error, 'error');
            return;
        }
        appendToTerminal('File saved: '+currentFile,'out');
    })
    .catch(err=>appendToTerminal('Error saving file: '+err,'error'));
}
editor.addCommand(monaco.KeyMod.CtrlCmd|monaco.KeyCode.KeyS,saveFile);

/*── CRUD (create / rename / delete) ─────────────────────*/
window.createNewFile=function(){
    const name=prompt('Enter file name:');if(!name)return hideContextMenu();
    const base=contextMenuTarget?.dataset.path??'';const path=base?`${base}/${name}`:name;
    
    // Create request data with path, content, and optional project_id or conversation_id
    const requestData = { path, content: '' };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/save_file/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(res=>{
        res.error ? appendToTerminal('Error creating file: '+res.error,'error')
                  : appendToTerminal('File created: '+path,'out');
        refreshTree();
    })
    .catch(err=>appendToTerminal('Error creating file: '+err,'error'))
    .finally(hideContextMenu);
};
window.createNewFolder=function(){
    const name=prompt('Enter folder name:');if(!name)return hideContextMenu();
    const base=contextMenuTarget?.dataset.path??'';const path=base?`${base}/${name}`:name;
    
    // Create request data with path and optional project_id or conversation_id
    const requestData = { path };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/create_folder/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(res=>{
        res.error ? appendToTerminal('Error creating folder: '+res.error,'error')
                  : appendToTerminal('Folder created: '+path,'out');
        refreshTree();
    })
    .catch(err=>appendToTerminal('Error creating folder: '+err,'error'))
    .finally(hideContextMenu);
};
window.renameItem=function(){
    if(!contextMenuTarget)return hideContextMenu();
    const old=contextMenuTarget.dataset.path;
    const curName=contextMenuTarget.textContent.trim();
    const newName=prompt('Enter new name:',curName);
    if(!newName||newName===curName)return hideContextMenu();
    const parent=old.substring(0,old.lastIndexOf('/'));
    const newPath=parent?`${parent}/${newName}`:newName;
    
    // Create request data with paths and optional project_id or conversation_id
    const requestData = { old_path: old, new_path: newPath };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/rename_item/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(res=>{
        res.error ? appendToTerminal('Error renaming: '+res.error,'error')
                  : appendToTerminal(`Renamed ${old} ➜ ${newPath}`,'out');
        refreshTree();
    })
    .catch(err=>appendToTerminal('Error renaming item: '+err,'error'))
    .finally(hideContextMenu);
};
window.deleteItem=function(){
    if(!contextMenuTarget)return hideContextMenu();
    const path=contextMenuTarget.dataset.path;
    const isDir=!!contextMenuTarget.querySelector('.mdi-folder,.mdi-folder-hidden');
    const type=isDir?'folder':'file';
    if(!confirm(`Delete this ${type}?\n${path}`))return hideContextMenu();
    
    // Create request data with path, is_directory, and optional project_id or conversation_id
    const requestData = { path, is_directory: isDir };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/delete_item/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(res=>{
        res.error ? appendToTerminal('Error deleting: '+res.error,'error')
                  : appendToTerminal(`Deleted ${type}: ${path}`,'out');
        if(path===currentFile){
            editor.setModel(monaco.editor.createModel('','plaintext'));
            currentFile='';
            if(activeItem)activeItem.classList.remove('active');
        }
        refreshTree();
    })
    .catch(err=>appendToTerminal('Error deleting item: '+err,'error'))
    .finally(hideContextMenu);
};

/*─────────────────────────────────────────────────────────
  Terminal
─────────────────────────────────────────────────────────*/
const tIn=document.getElementById('terminal-input');
const tOut=document.getElementById('terminal-output');

tIn.addEventListener('keypress',e=>{
    if(e.key!=='Enter')return;
    const cmd=e.target.value.trim();
    e.target.value='';
    if(!cmd){
        /* If user just hits Enter, echo a blank prompt line */
        appendToTerminal('$','cmd');
        return;
    }

    /* built‑ins -----------------------------------------------------*/
    if(cmd==='clear'||cmd==='cls'){tOut.innerHTML='';return;}

    appendToTerminal('$ '+cmd,'cmd');
    
    // Create request data with command and optional project_id or conversation_id
    const requestData = { command: cmd };
    if (projectId) requestData.project_id = projectId;
    if (conversationId) requestData.conversation_id = conversationId;

    fetch('/coding/execute_command/',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(requestData)
    })
    .then(r=>r.json())
    .then(res=>{
        if (res.error) {
            appendToTerminal(res.error, 'error');
            return;
        }
        if(res.stdout)appendToTerminal(res.stdout,'out');
        if(res.stderr)appendToTerminal(res.stderr,'error');
    })
    .catch(err=>appendToTerminal('Error executing command: '+err,'error'));
});

function appendToTerminal(text,type='out'){
    const div=document.createElement('div');
    div.className='terminal-output '+type;
    div.textContent=text;
    tOut.appendChild(div);
    /* Auto‑scroll terminal container */
    const termEl=document.getElementById('terminal');
    termEl.scrollTop=termEl.scrollHeight;
}

/*─────────────────────────────────────────────────────────
  Initial load
─────────────────────────────────────────────────────────*/
loadFileTree();
});/* end require */

/*─────────────────────────────────────────────────────────────
  Vertical resizer (explorer width)
─────────────────────────────────────────────────────────────*/
const resizer=document.getElementById('resizer');
const fileExplorer=document.getElementById('file-explorer');
let xDrag=false,lastX=0;
resizer.addEventListener('mousedown',e=>{
    xDrag=true;lastX=e.clientX;
    resizer.classList.add('dragging');document.body.classList.add('dragging');
});
document.addEventListener('mousemove',e=>{
    if(!xDrag)return;
    const dx=e.clientX-lastX;lastX=e.clientX;
    const w=fileExplorer.offsetWidth+dx;
    if(w>=100&&w<=600)fileExplorer.style.width=w+'px';
});
document.addEventListener('mouseup',()=>{
    if(!xDrag)return;
    xDrag=false;resizer.classList.remove('dragging');document.body.classList.remove('dragging');
});

// Setup variables and functions when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Only initialize terminal if we have a terminal container
    const terminalContainer = document.getElementById('terminal');
    if (terminalContainer) {
        initializeTerminal();
    }
});

// Global variables for terminal management
let terminalIframe = null;
let statusElement = null;
let openExternalButton = null;
let terminalConnected = false;
let terminalConnectionTimeout = null;
let lastTtydUrl = null;

// Initialize terminal on page load
function initializeTerminal() {
    // Reset connection tracking
    terminalConnected = false;
    if (terminalConnectionTimeout) {
        clearTimeout(terminalConnectionTimeout);
        terminalConnectionTimeout = null;
    }

    // Get terminal elements
    terminalIframe = document.getElementById('terminal-iframe');
    statusElement = document.getElementById('terminal-status');
    openExternalButton = document.getElementById('open-external-terminal');
    
    if (!terminalIframe) {
        console.error('Terminal iframe not found');
        return;
    }

    // Start with loading status
    updateTerminalStatus('Connecting...', '#fcce0c');
    
    // Display loading message in iframe while we initialize
    try {
        const iframeDoc = terminalIframe.contentDocument || terminalIframe.contentWindow.document;
        
        // Create content programmatically instead of using template literals
        iframeDoc.body.innerHTML = ''; // Clear first
        
        // Create main container
        const container = iframeDoc.createElement('div');
        container.style.padding = '15px';
        container.style.color = '#d4d4d4';
        container.style.fontFamily = 'sans-serif';
        container.style.textAlign = 'center';
        
        // Add title
        const title = iframeDoc.createElement('h3');
        title.textContent = 'Creating Your Development Environment';
        container.appendChild(title);
        
        // Create progress container
        const progressContainer = iframeDoc.createElement('div');
        progressContainer.style.margin = '30px auto';
        progressContainer.style.maxWidth = '400px';
        container.appendChild(progressContainer);
        
        // Create progress bar
        const progressBarContainer = iframeDoc.createElement('div');
        progressBarContainer.style.height = '6px';
        progressBarContainer.style.background = '#333';
        progressBarContainer.style.borderRadius = '3px';
        progressBarContainer.style.margin = '20px 0';
        progressContainer.appendChild(progressBarContainer);
        
        const progressBar = iframeDoc.createElement('div');
        progressBar.id = 'progress-bar';
        progressBar.style.width = '25%';
        progressBar.style.height = '100%';
        progressBar.style.background = '#2ea043';
        progressBar.style.borderRadius = '3px';
        progressBar.style.transition = 'width 1s';
        progressBarContainer.appendChild(progressBar);
        
        // Create progress label
        const progressLabel = iframeDoc.createElement('div');
        progressLabel.id = 'progress-label';
        progressLabel.style.textAlign = 'center';
        progressLabel.style.fontSize = '14px';
        progressLabel.style.marginBottom = '30px';
        progressLabel.style.color = '#ccc';
        progressLabel.textContent = 'Initializing your environment...';
        progressContainer.appendChild(progressLabel);
        
        // Create credentials box (hidden initially)
        const credentialsBox = iframeDoc.createElement('div');
        credentialsBox.id = 'credentials-box';
        credentialsBox.style.margin = '20px auto';
        credentialsBox.style.width = '80%';
        credentialsBox.style.maxWidth = '400px';
        credentialsBox.style.background = '#252526';
        credentialsBox.style.padding = '15px';
        credentialsBox.style.borderRadius = '5px';
        credentialsBox.style.borderLeft = '4px solid #f3ca3c';
        credentialsBox.style.display = 'none';
        container.appendChild(credentialsBox);
        
        // Add credentials title
        const credentialsTitle = iframeDoc.createElement('p');
        credentialsTitle.style.margin = '0 0 10px 0';
        credentialsTitle.style.fontWeight = 'bold';
        credentialsTitle.style.color = '#f3ca3c';
        credentialsTitle.textContent = 'Login Credentials:';
        credentialsBox.appendChild(credentialsTitle);
        
        // Add username row
        const usernameRow = iframeDoc.createElement('div');
        usernameRow.style.display = 'flex';
        usernameRow.style.justifyContent = 'space-between';
        usernameRow.style.background = '#1e1e1e';
        usernameRow.style.padding = '8px';
        usernameRow.style.borderRadius = '4px';
        usernameRow.style.marginBottom = '5px';
        credentialsBox.appendChild(usernameRow);
        
        const usernameLabel = iframeDoc.createElement('span');
        usernameLabel.textContent = 'Username:';
        usernameRow.appendChild(usernameLabel);
        
        const usernameValue = iframeDoc.createElement('code');
        usernameValue.style.background = '#333';
        usernameValue.style.padding = '2px 6px';
        usernameValue.style.borderRadius = '3px';
        usernameValue.textContent = 'user';
        usernameRow.appendChild(usernameValue);
        
        // Add password row
        const passwordRow = iframeDoc.createElement('div');
        passwordRow.style.display = 'flex';
        passwordRow.style.justifyContent = 'space-between';
        passwordRow.style.background = '#1e1e1e';
        passwordRow.style.padding = '8px';
        passwordRow.style.borderRadius = '4px';
        credentialsBox.appendChild(passwordRow);
        
        const passwordLabel = iframeDoc.createElement('span');
        passwordLabel.textContent = 'Password:';
        passwordRow.appendChild(passwordLabel);
        
        const passwordValue = iframeDoc.createElement('code');
        passwordValue.style.background = '#333';
        passwordValue.style.padding = '2px 6px';
        passwordValue.style.borderRadius = '3px';
        passwordValue.textContent = 'password';
        passwordRow.appendChild(passwordValue);
        
        // Add script for progress animation
        const script = iframeDoc.createElement('script');
        script.textContent = `
            const progressStages = ["Initializing your environment...", "Creating Kubernetes pod...", "Setting up terminal service...", "Ready to connect!"];
            const progressBar = document.getElementById("progress-bar");
            const progressLabel = document.getElementById("progress-label");
            const credentialsBox = document.getElementById("credentials-box");
            let currentStage = 0;
            
            function updateStage() {
              progressLabel.textContent = progressStages[currentStage];
              progressBar.style.width = ((currentStage + 1) * 25) + "%";
              if (currentStage === 3) credentialsBox.style.display = "block";
            }
            
            // Simulate progress (this will be replaced by real progress from the server)
            setTimeout(() => { currentStage = 1; updateStage(); }, 2000);
            setTimeout(() => { currentStage = 2; updateStage(); }, 4000);
            setTimeout(() => { currentStage = 3; updateStage(); }, 6000);
        `;
        
        // Add style tag for body
        const style = iframeDoc.createElement('style');
        style.textContent = `
            body {
                background: #1e1e1e;
                margin: 0;
                padding: 0;
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
            }
        `;
        
        // Append everything to document
        iframeDoc.body.appendChild(container);
        iframeDoc.body.appendChild(script);
        iframeDoc.head.appendChild(style);
        
    } catch (e) {
        console.error('Could not set loading message in iframe:', e);
    }
    
    // Start the connection process
    fetchPodInfo();
}

// Update terminal connection status display
function updateTerminalStatus(status, color) {
    if (statusElement) {
        statusElement.textContent = `(${status})`;
        statusElement.style.color = color;
        
        // Help overlay removed as requested
    }
}

function fetchPodInfo() {
    // Create request data with project_id or conversation_id
    const requestData = {};
    
    // Get project or conversation ID from data attributes
    const terminalContainer = document.getElementById('terminal');
    console.log('Terminal container found:', terminalContainer ? 'yes' : 'no');
    
    if (terminalContainer) {
        const projectId = terminalContainer.getAttribute('data-project-id');
        const conversationId = terminalContainer.getAttribute('data-conversation-id');
        
        console.log('Data attributes:', {
            'data-project-id': projectId,
            'data-conversation-id': conversationId
        });
        
        if (projectId) {
            requestData.project_id = projectId;
        } else if (conversationId) {
            requestData.conversation_id = conversationId;
        }
    } else {
        console.error('Terminal container element not found in DOM');
    }
    
    // If neither project_id nor conversation_id, try to get from URL parameters as fallback
    if (!requestData.project_id && !requestData.conversation_id) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlProjectId = urlParams.get('project_id');
        const urlConversationId = urlParams.get('conversation_id');
        
        console.log('URL parameters:', {
            'project_id': urlProjectId,
            'conversation_id': urlConversationId
        });
        
        if (urlProjectId) {
            requestData.project_id = urlProjectId;
        } else if (urlConversationId) {
            requestData.conversation_id = urlConversationId;
        }
    }
    
    console.log('Request data being sent:', requestData);
    
    // Fetch sandbox/pod info to get the ttyd URL
    fetch('/coding/k8s/get_pod_info/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        console.log('Pod info response:', data);
        
        if (data.error) {
            updateTerminalStatus('Error: ' + data.error, '#f14c4c');
            console.error('Error fetching pod info:', data.error);
            
            // Display the error in the iframe
            try {
                showTerminalError('pod info endpoint', data);
            } catch (e) {
                console.error('Failed to show error in iframe:', e);
            }
            
            // Try again after delay
            setTimeout(fetchPodInfo, 5000);
            return;
        }
        
        // Get ttydUrl from top level (preferred) or from service_details
        const ttydUrl = data.ttydUrl || (data.service_details && data.service_details.ttydUrl);
        
        // If we don't have a ttyd URL but have enough information, try to construct it
        let constructedTtydUrl = null;
        if (!ttydUrl && data.service_details) {
            const nodeIP = data.service_details.nodeIP;
            const ttydPort = data.service_details.ttydPort;
            
            if (nodeIP && ttydPort) {
                constructedTtydUrl = `http://${nodeIP}:${ttydPort}`;
                console.log('Constructed ttydUrl from pieces:', constructedTtydUrl);
            }
        }
        
        // Check if we have a ttyd URL (either provided or constructed)
        if (ttydUrl || constructedTtydUrl) {
            const finalTtydUrl = ttydUrl || constructedTtydUrl;
            console.log('Loading ttyd URL:', finalTtydUrl);
            updateTerminalStatus('Connected', '#4caf50');
            
            // Save the URL for potential reuse
            lastTtydUrl = finalTtydUrl;
            
            // Add query parameters for automatic login if possible
            let ttydUrlWithCredentials = finalTtydUrl;
            
            // Try to parse the URL to see if we can add credentials directly
            try {
                const urlObj = new URL(finalTtydUrl);
                // Add query parameters for username and password (will be used by our auto-login script)
                urlObj.searchParams.set('_username', 'user');
                urlObj.searchParams.set('_password', 'password');
                ttydUrlWithCredentials = urlObj.toString();
            } catch (e) {
                console.warn('Could not parse ttyd URL to add credentials:', e);
            }
            
            console.log('Using ttyd URL with credentials parameters:', ttydUrlWithCredentials);
            
            // Set up focus helpers after iframe loads
            terminalIframe.onload = function() {
                console.log('Terminal iframe loaded successfully');
                terminalConnected = true;
                
                // Try to focus the iframe after loading - multiple attempts with delay
                let focusAttempts = 0;
                const attemptFocus = function() {
                    if (focusAttempts > 5) return; // Give up after several attempts
                    
                    try {
                        terminalIframe.focus();
                        console.log(`Focus attempt ${focusAttempts+1}: Focused terminal iframe`);
                        
                        // Try to click inside the iframe to activate it
                        const iframeDoc = terminalIframe.contentDocument || terminalIframe.contentWindow.document;
                        if (iframeDoc && iframeDoc.body) {
                            console.log('Attempting to trigger focus in iframe body');
                            // Try to dispatch click event inside iframe
                            try {
                                const clickEvent = new MouseEvent('click', {
                                    bubbles: true,
                                    cancelable: true,
                                    view: terminalIframe.contentWindow
                                });
                                iframeDoc.body.dispatchEvent(clickEvent);
                                
                                // Try to auto-fill login form 
                                setTimeout(() => {
                                    try {
                                        console.log('Attempting to auto-fill login form in iframe');
                                        const form = iframeDoc.querySelector('form');
                                        const usernameInput = iframeDoc.querySelector('input[type="text"]');
                                        const passwordInput = iframeDoc.querySelector('input[type="password"]');
                                        const submitButton = iframeDoc.querySelector('button[type="button"]');
                                        
                                        if (usernameInput && passwordInput && submitButton) {
                                            console.log('Found login form, filling credentials');
                                            usernameInput.value = 'user';
                                            passwordInput.value = 'password';
                                            submitButton.click();
                                        } else {
                                            console.log('Login form not found in iframe');
                                        }
                                    } catch (e) {
                                        console.warn('Error auto-filling credentials in iframe:', e);
                                    }
                                }, 1000);
                            } catch (e) {
                                console.warn('Could not dispatch click in iframe:', e);
                            }
                        }
                    } catch (e) {
                        console.warn(`Focus attempt ${focusAttempts+1} failed: ${e}`);
                    }
                    
                    focusAttempts++;
                    setTimeout(attemptFocus, 1000); // Try again in 1 second
                };
                
                // Start focus attempts
                attemptFocus();
            };
            
            terminalIframe.onerror = function(error) {
                console.error('Failed to load terminal iframe:', error);
                updateTerminalStatus('Failed to connect', '#f14c4c');
                showTerminalError(finalTtydUrl, { 
                    error_details: 'The ttyd terminal service failed to load in the iframe.',
                    debug_info: {
                        pod_name: data.pod_name || 'unknown',
                        service_name: data.service_name || 'unknown',
                        constructed: !!constructedTtydUrl,
                        ttyd_port: data.service_details?.ttydPort,
                        node_ip: data.service_details?.nodeIP
                    }
                });
            };
            
            // Set iframe source to the ttyd URL with credentials
            terminalIframe.src = ttydUrlWithCredentials;
            
            // Update external button URL
            if (openExternalButton) {
                openExternalButton.onclick = function() {
                    // Store terminal credentials in localStorage for auto-login
                    try {
                        localStorage.setItem('terminal_username', 'user');
                        localStorage.setItem('terminal_password', 'password');
                    } catch (e) {
                        console.warn('Could not store terminal credentials in localStorage:', e);
                    }
                    
                    // Open in a named window with reasonable dimensions and ensure it gets focus
                    const terminalWindow = window.open(ttydUrlWithCredentials, 'terminal_window', 'width=800,height=600,menubar=no,toolbar=no,location=no,resizable=yes,scrollbars=yes,status=no');
                    if (terminalWindow) {
                        terminalWindow.focus();
                        console.log('Opened terminal in new window with focus');
                        
                        // Inject auto-login script into the new window
                        try {
                            terminalWindow.onload = function() {
                                console.log('Terminal window loaded, attempting auto-login');
                                const loginScript = 
                                    "setTimeout(function() {" +
                                    "  // Try to find username and password fields" +
                                    "  const usernameField = document.querySelector('input[type=\"text\"]');" +
                                    "  const passwordField = document.querySelector('input[type=\"password\"]');" +
                                    "  const loginButton = document.querySelector('button[type=\"button\"]');" +
                                    "  " +
                                    "  if (usernameField && passwordField && loginButton) {" +
                                    "    console.log('Found login form, attempting to fill credentials');" +
                                    "    usernameField.value = 'user';" +
                                    "    passwordField.value = 'password';" +
                                    "    loginButton.click();" +
                                    "  } else {" +
                                    "    console.log('Login form elements not found');" +
                                    "  }" +
                                    "}, 1000);";
                                
                                // Add the script to the new window
                                const scriptEl = terminalWindow.document.createElement('script');
                                scriptEl.textContent = loginScript;
                                terminalWindow.document.body.appendChild(scriptEl);
                            };
                        } catch (e) {
                            console.warn('Could not inject auto-login script:', e);
                        }
                    }
                    return false; // Prevent default action
                };
            }
            
            // Clear any previous failure timers
            if (terminalConnectionTimeout) {
                clearTimeout(terminalConnectionTimeout);
            }
            
            // Set a timeout to detect if the terminal doesn't respond
            terminalConnectionTimeout = setTimeout(function() {
                // Only check if we haven't confirmed success yet
                if (!terminalConnected) {
                    console.warn('Terminal connection may have failed - no confirmation within timeout period');
                    // We don't update status here since the iframe load/error handlers will handle that
                }
            }, 10000);
        } else {
            // We don't have a ttyd URL - handle error
            console.error('No ttydUrl returned from server', data);
            
            // Check if there's a warning about recreation
            if (data.warning) {
                updateTerminalStatus(data.warning, '#fcce0c');
            } else {
                updateTerminalStatus('Waiting for terminal service...', '#fcce0c');
            }
            
            // Show detailed error in the iframe with specific information
            const errorDetails = data.warning || 'The server did not provide a ttyd terminal URL.';
            const debugInfo = data.debug_info || {
                pod_name: data.pod_name || 'unknown',
                service_name: data.service_name || 'unknown',
                message: 'The ttyd service may still be starting or encountered an issue.'
            };
            
            showTerminalError('ttyd service', {
                error_details: errorDetails,
                debug_info: debugInfo
            });
            
            // Try again after delay
            setTimeout(fetchPodInfo, 5000);
        }
    })
    .catch(error => {
        console.error('Error fetching pod info:', error);
        updateTerminalStatus('Connection error', '#f14c4c');
        
        // Show error in iframe
        showTerminalError('API endpoint', {
            error_details: error.toString(),
            debug_info: {
                message: 'Failed to connect to the pod info endpoint. Server may be unavailable.'
            }
        });
        
        // Try again after delay
        setTimeout(fetchPodInfo, 5000);
    });
}

// Function to show terminal error in iframe
function showTerminalError(url, errorData = null) {
    try {
        const iframeDoc = terminalIframe.contentDocument || terminalIframe.contentWindow.document;
        
        // Format any debug info for display
        let debugInfoHtml = '';
        if (errorData) {
            if (errorData.debug_info) {
                debugInfoHtml = `
                    <div style="margin-top: 15px; padding: 10px; background: #252526; border-radius: 3px;">
                        <h4 style="margin-top: 0; color: #fcce0c;">Debug Information:</h4>
                        <pre style="margin: 0; color: #bbb; font-size: 12px;">${JSON.stringify(errorData.debug_info, null, 2)}</pre>
                    </div>
                `;
            }
            
            if (errorData.error_details) {
                debugInfoHtml += `
                    <div style="margin-top: 10px;">
                        <p style="color: #f14c4c;">${errorData.error_details}</p>
                    </div>
                `;
            }
        }
        
        iframeDoc.body.innerHTML = `
            <div style="padding: 15px; color: #d4d4d4; font-family: sans-serif;">
                <h3 style="color: #f14c4c;">Terminal Connection Failed</h3>
                <p>Could not connect to the ttyd terminal service.</p>
                <p>Error details: Could not load ${url}</p>
                
                <div style="margin: 20px 0; background: #252526; padding: 15px; border-radius: 5px; border-left: 4px solid #f3ca3c;">
                    <p style="margin: 0 0 10px 0; font-weight: bold; color: #f3ca3c;">When connection resumes, you'll need:</p>
                    <div style="display: flex; justify-content: space-between; background: #1e1e1e; padding: 8px; border-radius: 4px; margin-bottom: 5px;">
                        <span>Username:</span>
                        <code style="background: #333; padding: 2px 6px; border-radius: 3px;">user</code>
                    </div>
                    <div style="display: flex; justify-content: space-between; background: #1e1e1e; padding: 8px; border-radius: 4px;">
                        <span>Password:</span>
                        <code style="background: #333; padding: 2px 6px; border-radius: 3px;">password</code>
                    </div>
                </div>
                
                <p>Check the browser console for more information.</p>
                ${debugInfoHtml}
                <div style="margin-top: 15px;">
                    <button onclick="window.parent.initializeTerminal()" style="background: #0e639c; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; font-weight: bold;">
                        <i class="mdi mdi-refresh" style="margin-right: 5px;"></i> Retry Connection
                    </button>
                </div>
                
                <p style="margin-top: 15px; font-size: 12px; color: #999;">Tip: Try refreshing the entire page if the issue persists.</p>
            </div>
        `;
    } catch (e) {
        console.error('Could not modify iframe content:', e);
    }
}

/*─────────────────────────────────────────────────────────────
  Horizontal resizer (terminal height)
─────────────────────────────────────────────────────────────*/
const hRes=document.getElementById('h-resizer');
const termEl=document.getElementById('terminal');
let yDrag=false,startY=0,startH=0;

hRes.addEventListener('mousedown', e=> {
    yDrag=true;
    startY=e.clientY;
    startH=termEl.offsetHeight;
    console.log('h-resizer mousedown', {startY, startH});
    hRes.classList.add('dragging');
    document.body.classList.add('dragging');
});

document.addEventListener('mousemove',e=>{
    if(!yDrag)
        return;
    const dy=startY - e.clientY;            /* up = larger terminal */
    const newH=startH + dy;                /* invert direction */
    console.log('h-resizer mousemove', {dy, newH});
    if(newH < 100 || newH > window.innerHeight*0.8) return;
    termEl.style.height=newH+'px';
    const monEl=document.getElementById('monaco-editor');
    monEl.style.height=newH+'px';
    /* Let flexbox handle editor height, just relayout Monaco */
    if(window.editor)window.editor.layout();
});

document.addEventListener('mouseup',()=>{
    if(!yDrag)return;
    yDrag=false;hRes.classList.remove('dragging');document.body.classList.remove('dragging');
    console.log('h-resizer mouseup', {finalHeight: termEl.offsetHeight});
});

// Helper function to get cookies (for CSRF token)
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function showTerminalHelp() {
    // Create a visible modal-like message about using external window
    const helpOverlay = document.createElement('div');
    helpOverlay.style.position = 'absolute';
    helpOverlay.style.top = '50%';
    helpOverlay.style.left = '50%';
    helpOverlay.style.transform = 'translate(-50%, -50%)';
    helpOverlay.style.backgroundColor = '#2d2d2d';
    helpOverlay.style.padding = '25px';
    helpOverlay.style.borderRadius = '8px';
    helpOverlay.style.boxShadow = '0 0 20px rgba(0,0,0,0.7)';
    helpOverlay.style.zIndex = '1000';
    helpOverlay.style.maxWidth = '450px';
    helpOverlay.style.textAlign = 'center';
    helpOverlay.style.border = '1px solid #4a4a4a';
    helpOverlay.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:center; margin-bottom:15px; color:#f3ca3c;">
            <i class="mdi mdi-lightbulb-on" style="font-size:28px; margin-right:10px;"></i>
            <h3 style="margin:0; color:#f3ca3c;">Important Terminal Instructions</h3>
        </div>
        <p style="margin-bottom:20px;">Please follow these steps to use the terminal:</p>
        
        <div style="background:#1e1e1e; padding:15px; border-radius:5px; margin-bottom:20px; text-align:left; border-left:4px solid #2ea043;">
            <p style="margin-top:0;"><strong style="color:#2ea043;">Step 1:</strong> Use the <strong style="color:#2ea043;">Open Terminal in New Window</strong> button for best experience.</p>
            
            <div style="background:#252526; padding:12px; border-radius:4px; margin:15px 0; border:1px solid #333;">
                <p style="margin:0; font-weight:bold; color:#f3ca3c;">Login Credentials:</p>
                <div style="display:flex; justify-content:space-between; margin-top:8px;">
                    <span>Username:</span>
                    <code style="background:#1e1e1e; padding:3px 8px; border-radius:3px;">user</code>
                </div>
                <div style="display:flex; justify-content:space-between; margin-top:5px;">
                    <span>Password:</span>
                    <code style="background:#1e1e1e; padding:3px 8px; border-radius:3px;">password</code>
                </div>
            </div>
            
            <p><strong style="color:#2ea043;">Step 3:</strong> If you see a blank screen after login, try refreshing the page.</p>
        </div>
        
        <p style="color:#bbb; font-size:12px; margin-bottom:20px;">The terminal service requires authentication and may work better in a separate window due to browser security restrictions.</p>
        
        <button id="dismiss-terminal-help" style="background:#2ea043; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer; font-weight:bold; display:flex; align-items:center; margin:0 auto;">
            <i class="mdi mdi-check" style="margin-right:5px;"></i> Got it!
        </button>
    `;
    
    const terminalContainer = document.getElementById('terminal');
    if (terminalContainer) {
        terminalContainer.style.position = 'relative';
        terminalContainer.appendChild(helpOverlay);
        
        // Add dismiss button handler
        document.getElementById('dismiss-terminal-help').addEventListener('click', function() {
            helpOverlay.style.display = 'none';
        });
    }
}
</script>
{% endif %}
</body>
</html>
